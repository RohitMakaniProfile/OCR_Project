<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Handwritten OCR + PII Extraction</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
    }
    h1 {
      margin-bottom: 10px;
    }
    .card {
      background: #fff;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .preview-img {
      max-width: 100%;
      max-height: 400px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .flex {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .flex > div {
      flex: 1 1 320px;
    }
    button {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      background: #1976d2;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    input[type="file"] {
      margin-top: 8px;
      margin-bottom: 12px;
    }
    pre {
      background: #222;
      color: #f3f3f3;
      padding: 10px;
      border-radius: 4px;
      max-height: 400px;
      overflow: auto;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      background: #eee;
      margin-right: 4px;
    }
    #status {
      font-size: 14px;
      margin-top: 6px;
    }
    #status.error {
      color: #c62828;
    }
    #status.ok {
      color: #2e7d32;
    }
  </style>
</head>
<body>

  <h1>Handwritten OCR + PII Extraction (EasyOCR)</h1>

  <div class="card">
    <form id="uploadForm">
      <label for="image">Upload handwritten medical document (JPEG/PNG):</label><br>
      <input type="file" id="image" name="image" accept=".jpg,.jpeg,.png" required>
      <br>
      <button type="submit" id="submitBtn">Run OCR + PII</button>
      <div id="status"></div>
    </form>
  </div>

  <div class="flex">
    <div class="card">
      <h2>Original / Redacted Preview</h2>
      <div>
        <span class="badge">Original</span><br>
        <img id="originalPreview" class="preview-img" src="" alt="Original will appear here">
      </div>
      <br>
      <div>
        <span class="badge">Redacted</span><br>
        <img id="redactedPreview" class="preview-img" src="" alt="Redacted will appear here">
      </div>
    </div>

    <div class="card">
      <h2>PII Items Detected</h2>
      <table id="piiTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Value</th>
            <th>Line</th>
            <th>Page</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Full OCR Text</h2>
    <pre id="fullText">Upload a document and run OCR to see the extracted text here.</pre>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");

    const originalPreview = document.getElementById("originalPreview");
    const redactedPreview = document.getElementById("redactedPreview");
    const piiTableBody = document.querySelector("#piiTable tbody");
    const fullTextEl = document.getElementById("fullText");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const fileInput = document.getElementById("image");
      if (!fileInput.files[0]) {
        statusEl.textContent = "Please select an image file.";
        statusEl.className = "error";
        return;
      }

      const formData = new FormData();
      formData.append("image", fileInput.files[0]);

      submitBtn.disabled = true;
      statusEl.textContent = "Processing OCR & PII extraction...";
      statusEl.className = "";

      try {
        const response = await fetch("/upload", {
          method: "POST",
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          statusEl.textContent = data.error || "Something went wrong.";
          statusEl.className = "error";
          submitBtn.disabled = false;
          return;
        }

        // Update status
        statusEl.textContent = "Done!";
        statusEl.className = "ok";

        // Original image preview
        if (data.uploaded_image_url) {
  originalPreview.src = data.uploaded_image_url;
}

if (data.redacted_image_url) {
  redactedPreview.src = data.redacted_image_url;
}

        // Full text
        if (data.full_text) {
          fullTextEl.textContent = data.full_text;
        } else {
          fullTextEl.textContent = "(No text extracted)";
        }

        // PII table
        piiTableBody.innerHTML = "";
        if (Array.isArray(data.pii_items) && data.pii_items.length > 0) {
          data.pii_items.forEach(item => {
            const tr = document.createElement("tr");

            const tdType = document.createElement("td");
            tdType.textContent = item.type || "";
            tr.appendChild(tdType);

            const tdValue = document.createElement("td");
            tdValue.textContent = item.value || "";
            tr.appendChild(tdValue);

            const tdLine = document.createElement("td");
            tdLine.textContent = (item.line !== undefined) ? item.line : "";
            tr.appendChild(tdLine);

            const tdPage = document.createElement("td");
            tdPage.textContent = item.page || "";
            tr.appendChild(tdPage);

            piiTableBody.appendChild(tr);
          });
        } else {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 4;
          td.textContent = "No PII detected.";
          tr.appendChild(td);
          piiTableBody.appendChild(tr);
        }

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
        statusEl.className = "error";
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>

</body>
</html>
